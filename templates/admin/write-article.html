<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
</head>
<style>
  .ql-toolbar .ql-formats {
      margin-right: 15px;
  }
  .ql-toolbar .ql-insertCodeBlock::after,
  .ql-toolbar .ql-insertTip::after,
  .ql-toolbar .ql-insertSummary::after,
  .ql-toolbar .ql-insertWarning::after,
  .ql-toolbar .ql-insertExample::after,
  .ql-toolbar .ql-insertYouTube::after {
      content: attr(data-label);
  }
</style>

<body>

  <header class="navbar sticky-top bg-dark flex-md-nowrap p-0 shadow" data-bs-theme="dark">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6 text-white" href="#">Tilburg Science Hub</a>
  </header>

  <div class="container-fluid">
    <div class="row">
      <div style="min-height: 100vh;" class="sidebar border border-right col-md-3 col-lg-2 p-0 bg-body-tertiary">
        <div class="offcanvas-md offcanvas-end bg-body-tertiary" tabindex="-1" id="sidebarMenu"
          aria-labelledby="sidebarMenuLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarMenuLabel">Tilburg Science Hub</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarMenu"
              aria-label="Close"></button>
          </div>
          <div class="offcanvas-body d-md-flex flex-column p-0 pt-lg-3 overflow-y-auto">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link d-flex align-items-center gap-2 active" aria-current="page" href="">
                  Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link d-flex align-items-center gap-2" href="">
                  Articles
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link d-flex align-items-center gap-2" href="{{ url_for('admin_write_article') }}">
                  Create Article
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link d-flex align-items-center gap-2" href="{{ url_for('stats') }}">
                  Statistics
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Create Article</h1>
          <div class="d-flex">
            <button class="btn btn-primary" id="save-button">Save</button>
            <button class="btn btn-secondary" id="recompile-button">Recompile</button>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div>
              <label for="title">Title:</label>
              <input type="text" id="title" name="title"><br>

              <label for="description">Description:</label>
              <input type="text" id="description" name="description"><br>

              <label for="author">Author:</label>
              <input type="text" id="author" name="author"><br>

              <label for="draft">Draft:</label>
              <select id="draft" name="draft">
                <option value="true">True</option>
                <option value="false">False</option>
              </select><br>
            </div>
            <div id="toolbar-container">
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button id="custom-button" data-label="Code">C</button>
              <button id="tip-button" data-label="Tip">T</button>
              <button id="summary-button" data-label="Summary">S</button>
              <button id="warning-button" data-label="Warning">W</button>
              <button id="example-button" data-label="Example">E</button>
              <button id="youtube-button" data-label="YouTube">Y</button>
            </div>
            <div id="editor-container" style="height: 400px;">
            </div>
          </div>
          <div class="col-md-6">
            <iframe id="preview-iframe" src="{{ url_for('render_template_view')}}" width="100%" height="100%"></iframe>
          </div>
        </div>
      </main>
    </div>
  </div>
  <script src="/docs/5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.2/dist/chart.umd.js"
    integrity="sha384-eI7PSr3L1XLISH8JdDII5YN/njoSsxfbrkCTnJrzXt+ENP5MOVBxD+l6sEG4zoLp"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

  <!-- Initialize Quill editor -->
  <script>
    var quill = new Quill('#editor-container', {
      theme: 'snow',
      modules: {
        toolbar: '#toolbar-container'
      },
      placeholder: 'Compose an epic...'
    });

    function insertMarkdown(shortcode) {
      const range = quill.getSelection();
      if (range) {
        quill.insertText(range.index, shortcode);
      }
    }

    var customButton = document.querySelector('#custom-button');
    customButton.addEventListener('click', function () {
      const codeBlock = `
{{ '{{%' }} codeblock %}}
\`\`\`language
# code
\`\`\`
{{ '{{%' }} /codeblock %}}`;
      insertMarkdown(codeBlock);
    });

    var tipButton = document.querySelector('#tip-button');
    tipButton.addEventListener('click', function () {
      const tipBlock = `
{{ '{{%' }} tip %}}
Your tip content here.
{{ '{{%' }} /tip %}}`;
      insertMarkdown(tipBlock);
    });

    var summaryButton = document.querySelector('#summary-button');
    summaryButton.addEventListener('click', function () {
      const summaryBlock = `
{{ '{{%' }} summary %}}
Your summary content here.
{{ '{{%' }} /summary %}}`;
      insertMarkdown(summaryBlock);
    });

    var warningButton = document.querySelector('#warning-button');
    warningButton.addEventListener('click', function () {
      const warningBlock = `
{{ '{{%' }} warning %}}
Your warning content here.
{{ '{{%' }} /warning %}}`;
      insertMarkdown(warningBlock);
    });

    var exampleButton = document.querySelector('#example-button');
    exampleButton.addEventListener('click', function () {
      const exampleBlock = `
{{ '{{%' }} example %}}
Your example content here.
{{ '{{%' }} /example %}}`;
      insertMarkdown(exampleBlock);
    });

    var youtubeButton = document.querySelector('#youtube-button');
    youtubeButton.addEventListener('click', function () {
      const youtubeBlock = `
{{ '<' }} youtube video_id iframe-video-margins {{ '>' }}`;
      insertMarkdown(youtubeBlock);
    });

    function cleanHTML(input) {
      var doc = new DOMParser().parseFromString(input, 'text/html');
      var elements = doc.body.getElementsByTagName('*');
      for (var i = 0; i < elements.length; i++) {
        elements[i].removeAttribute('style');
      }
      return doc.body.innerHTML;
    }

    document.getElementById('recompile-button').addEventListener('click', function () {
      var content = quill.root.innerHTML;
      content = cleanHTML(content);  // Clean the HTML content

      var title = document.getElementById('title').value;
      var description = document.getElementById('description').value;
      var author = document.getElementById('author').value;
      var draft = document.getElementById('draft').value;

      fetch('/update_content', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          content: content,
          title: title,
          author: author
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Reload the iframe to reflect new content
            document.getElementById('preview-iframe').src = document.getElementById('preview-iframe').src;
          }
        });
    });
  </script>

</body>